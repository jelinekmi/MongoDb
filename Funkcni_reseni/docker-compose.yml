version: '3.8'

services:
  # Config servers
  configsvr1:
    image: mongo:6
    container_name: configsvr1
    command: >
      bash -c '
        if [ "$AUTH" = "enabled" ]; then
          mongod --configsvr --replSet cfgRS --port 27019 --bind_ip_all --auth --keyFile /etc/mongo-keyfile;
        else
          mongod --configsvr --replSet cfgRS --port 27019 --bind_ip_all;
        fi'
    ports: [ "27119:27019" ]
    volumes:
      - config1_data:/data/db
      - ./mongo-keyfile:/etc/mongo-keyfile:ro
    networks: [ mongo-net ]
    env_file:
      - .env

  configsvr2:
    image: mongo:6
    container_name: configsvr2
    command: >
      bash -c '
        if [ "$AUTH" = "enabled" ]; then
          mongod --configsvr --replSet cfgRS --port 27019 --bind_ip_all --auth --keyFile /etc/mongo-keyfile;
        else
          mongod --configsvr --replSet cfgRS --port 27019 --bind_ip_all;
        fi'
    ports: [ "27120:27019" ]
    volumes:
      - config2_data:/data/db
      - ./mongo-keyfile:/etc/mongo-keyfile:ro
    networks: [ mongo-net ]
    env_file:
      - .env

  configsvr3:
    image: mongo:6
    container_name: configsvr3
    command: >
      bash -c '
        if [ "$AUTH" = "enabled" ]; then
          mongod --configsvr --replSet cfgRS --port 27019 --bind_ip_all --auth --keyFile /etc/mongo-keyfile;
        else
          mongod --configsvr --replSet cfgRS --port 27019 --bind_ip_all;
        fi'
    ports: [ "27121:27019" ]
    volumes:
      - config3_data:/data/db
      - ./mongo-keyfile:/etc/mongo-keyfile:ro
    networks: [ mongo-net ]
    env_file:
      - .env

  mongos-router:
    image: mongo:6
    depends_on: [ configsvr1, configsvr2, configsvr3 ]
    command: >
      bash -c '
        sleep 20 &&
        if [ "$AUTH" = "enabled" ]; then
          mongos --configdb cfgRS/configsvr1:27019,configsvr2:27019,configsvr3:27019 \
                 --port 27017 --bind_ip_all --keyFile /etc/mongo-keyfile;
        else
          mongos --configdb cfgRS/configsvr1:27019,configsvr2:27019,configsvr3:27019 \
                 --port 27017 --bind_ip_all;
        fi'
    ports: [ "27017:27017" ]
    volumes:
      - ./mongo-keyfile:/etc/mongo-keyfile:ro
    networks: [ mongo-net ]
    env_file:
      - .env

  # Shards
  shard1a:
    image: mongo:6
    container_name: shard1a
    command: >
      bash -c '
        if [ "$AUTH" = "enabled" ]; then
          mongod --shardsvr --replSet shard1 --port 27101 --bind_ip_all --auth --keyFile /etc/mongo-keyfile;
        else
          mongod --shardsvr --replSet shard1 --port 27101 --bind_ip_all;
        fi'
    ports: [ "27101:27101" ]
    volumes:
      - shard1a_data:/data/db
      - ./mongo-keyfile:/etc/mongo-keyfile:ro
    networks: [ mongo-net ]
    env_file:
      - .env

  shard1b:
    image: mongo:6
    container_name: shard1b
    command: >
      bash -c '
        if [ "$AUTH" = "enabled" ]; then
          mongod --shardsvr --replSet shard1 --port 27102 --bind_ip_all --auth --keyFile /etc/mongo-keyfile;
        else
          mongod --shardsvr --replSet shard1 --port 27102 --bind_ip_all;
        fi'
    ports: [ "27102:27102" ]
    volumes:
      - shard1b_data:/data/db
      - ./mongo-keyfile:/etc/mongo-keyfile:ro
    networks: [ mongo-net ]
    env_file:
      - .env

  shard1c:
    image: mongo:6
    container_name: shard1c
    command: >
      bash -c '
        if [ "$AUTH" = "enabled" ]; then
          mongod --shardsvr --replSet shard1 --port 27103 --bind_ip_all --auth --keyFile /etc/mongo-keyfile;
        else
          mongod --shardsvr --replSet shard1 --port 27103 --bind_ip_all;
        fi'
    ports: [ "27103:27103" ]
    volumes:
      - shard1c_data:/data/db
      - ./mongo-keyfile:/etc/mongo-keyfile:ro
    networks: [ mongo-net ]
    env_file:
      - .env

  shard2a:
    image: mongo:6
    container_name: shard2a
    command: >
      bash -c '
        if [ "$AUTH" = "enabled" ]; then
          mongod --shardsvr --replSet shard2 --port 27201 --bind_ip_all --auth --keyFile /etc/mongo-keyfile;
        else
          mongod --shardsvr --replSet shard2 --port 27201 --bind_ip_all;
        fi'
    ports: [ "27201:27201" ]
    volumes:
      - shard2a_data:/data/db
      - ./mongo-keyfile:/etc/mongo-keyfile:ro
    networks: [ mongo-net ]
    env_file:
      - .env

  shard2b:
    image: mongo:6
    container_name: shard2b
    command: >
      bash -c '
        if [ "$AUTH" = "enabled" ]; then
          mongod --shardsvr --replSet shard2 --port 27202 --bind_ip_all --auth --keyFile /etc/mongo-keyfile;
        else
          mongod --shardsvr --replSet shard2 --port 27202 --bind_ip_all;
        fi'
    ports: [ "27202:27202" ]
    volumes:
      - shard2b_data:/data/db
      - ./mongo-keyfile:/etc/mongo-keyfile:ro
    networks: [ mongo-net ]
    env_file:
      - .env

  shard2c:
    image: mongo:6
    container_name: shard2c
    command: >
      bash -c '
        if [ "$AUTH" = "enabled" ]; then
          mongod --shardsvr --replSet shard2 --port 27203 --bind_ip_all --auth --keyFile /etc/mongo-keyfile;
        else
          mongod --shardsvr --replSet shard2 --port 27203 --bind_ip_all;
        fi'
    ports: [ "27203:27203" ]
    volumes:
      - shard2c_data:/data/db
      - ./mongo-keyfile:/etc/mongo-keyfile:ro
    networks: [ mongo-net ]
    env_file:
      - .env

  shard3a:
    image: mongo:6
    container_name: shard3a
    command: >
      bash -c '
        if [ "$AUTH" = "enabled" ]; then
          mongod --shardsvr --replSet shard3 --port 27301 --bind_ip_all --auth --keyFile /etc/mongo-keyfile;
        else
          mongod --shardsvr --replSet shard3 --port 27301 --bind_ip_all;
        fi'
    ports: [ "27301:27301" ]
    volumes:
      - shard3a_data:/data/db
      - ./mongo-keyfile:/etc/mongo-keyfile:ro
    networks: [ mongo-net ]
    env_file:
      - .env

  shard3b:
    image: mongo:6
    container_name: shard3b
    command: >
      bash -c '
        if [ "$AUTH" = "enabled" ]; then
          mongod --shardsvr --replSet shard3 --port 27302 --bind_ip_all --auth --keyFile /etc/mongo-keyfile;
        else
          mongod --shardsvr --replSet shard3 --port 27302 --bind_ip_all;
        fi'
    ports: [ "27302:27302" ]
    volumes:
      - shard3b_data:/data/db
      - ./mongo-keyfile:/etc/mongo-keyfile:ro
    networks: [ mongo-net ]
    env_file:
      - .env

  shard3c:
    image: mongo:6
    container_name: shard3c
    command: >
      bash -c '
        if [ "$AUTH" = "enabled" ]; then
          mongod --shardsvr --replSet shard3 --port 27303 --bind_ip_all --auth --keyFile /etc/mongo-keyfile;
        else
          mongod --shardsvr --replSet shard3 --port 27303 --bind_ip_all;
        fi'
    ports: [ "27303:27303" ]
    volumes:
      - shard3c_data:/data/db
      - ./mongo-keyfile:/etc/mongo-keyfile:ro
    networks: [ mongo-net ]
    env_file:
      - .env

  init-config:
    image: mongo:6
    container_name: init-config
    depends_on:
      - configsvr1
      - configsvr2
      - configsvr3
      - shard1a
      - shard1b
      - shard1c
      - shard2a
      - shard2b
      - shard2c
      - shard3a
      - shard3b
      - shard3c
    volumes:
      - ./init-config.sh:/init-config.sh
    entrypoint: ["bash", "/init-config.sh"]
    environment:
      - AUTH=${AUTH}
    networks: [ mongo-net ]


  # Init container
  init:
    image: mongo:6
    container_name: init
    depends_on:s
      - configsvr1
      - configsvr2
      - configsvr3
      - shard1a
      - shard1b
      - shard1c
      - shard2a
      - shard2b
      - shard2c
      - shard3a
      - shard3b
      - shard3c
    volumes:
      - ./init.sh:/init.sh
    entrypoint: ["bash", "/init.sh"]
    environment:
      - AUTH=${AUTH}
    networks: [ mongo-net ]

     # Data import
  importer:
    image: mongo:6
    container_name: importer
    depends_on: 
      - mongos-router
    volumes:
      - ./datasets:/datasets
    environment:
      - AUTH=${AUTH}
    entrypoint: >
      bash -c '
        echo " čekám na mongos..." &&
        until mongosh "mongodb://mongos-router:27017" --eval "db.adminCommand({ ping: 1 })" > /dev/null 2>&1; do
          sleep 2
        done &&
        echo " mongos připraven." &&

        if [ "$AUTH" = "enabled" ]; then
          echo "?? AUTH je enabled - importuji data..." &&
          mongoimport --host mongos-router --port 27017 -u admin -p admin --authenticationDatabase admin --db mydb --collection Products --file /datasets/products.json --jsonArray &&
          mongoimport --host mongos-router --port 27017 -u admin -p admin --authenticationDatabase admin --db mydb --collection Orders --file /datasets/orders.json --jsonArray &&
          mongoimport --host mongos-router --port 27017 -u admin -p admin --authenticationDatabase admin --db mydb --collection OrderItems --file /datasets/order_items.json --jsonArray;
        else
          echo "?? AUTH je disabled - import dat přeskočen.";
        fi'
    networks:
      - mongo-net

volumes:
  config1_data:
  config2_data:
  config3_data:
  shard1a_data:
  shard1b_data:
  shard1c_data:
  shard2a_data:
  shard2b_data:
  shard2c_data:
  shard3a_data:
  shard3b_data:
  shard3c_data:

networks:
  mongo-net:

